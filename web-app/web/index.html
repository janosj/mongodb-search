<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <meta name="description" content="Atlas Search" />
  <meta name="author" content="Jonathan Janos" />

  <title>Atlas Search</title>

  <!-- Bootstrap core CSS -->
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Custom fonts for this template -->
  <!--<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/js/all.min.js" rel="stylesheet" />-->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/simple-line-icons/2.4.1/css/simple-line-icons.css" rel="stylesheet" type="text/css" />
  <link href="https://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic,700italic" rel="stylesheet" type="text/css" />

  <!-- Custom styles for this template -->
  <link href="styles.css" rel="stylesheet" />

  <style>
    /* Ensures fixed footer doesn't overlap content */
    body {
      padding-bottom: 120px;
    }
    /* Search highlights */
    .hl {
      background-color: white; 
      color: green ;
    }
  </style>
  
</head>


<body>

  <!-- Search Bar -->
  <div class="container-fluid sticky-top bg-white">
    <div class="row border">
      <div class="col p-3" align="center">
        <form class="form" style="width: 50%">
          <div class="input-group">
            <img src="atlas-search-icon.png" style="display:block;" width="38" height="38">&nbsp;
            <label class="sr-only" for="alwaysAddLabels-invisible">Search Query</label>
            <!-- add width here to put spacing in front of button -->
            <input class="form-control" type="text" id="queryText" placeholder="Atlas Search">
            &nbsp;&nbsp;
            <button class="btn btn-light" type="button" id="submitBtn" onclick="submitQuery(0)">Search</button>
            &nbsp;&nbsp;
            <button class="btn btn-light" type="reset" onclick="resetPage()">Reset</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- 
    Content holder for Search Results.
    Empty at the outset, populated dynamically when the search results are retrieved.
  -->    
  <div class="container-fluid">
    <div class="row">
      <div class="col p-3">
        <div id="queryResults"></div>
      </div>
    </div>
  </div>

    <!-- 
    Content holder for pagination links.
    Empty at the outset, populated dynamically when the search results are retrieved.
    -->    
    <div class="container-fluid">
      <div class="row">
        <div class="col p-3" align="center">
          <div id="paginationLinks"></div>
        </div>
      </div>
      <input hidden id="hiddenPageNumber" value="0" />
      <input hidden id="hiddenQueryString" value="" />
    </div>


  <!-- 
    Footer. Anchored to bottom of the screen.
    Note: padding-bottom is required in body style to prevent overlapping content. 
    Note: None of these links work - it's just for the look, helps it look like a real web app.
  -->
  <div class="container-fluid fixed-bottom bg-light">
    <div class="row border p-3">
      <div class="col text-center text-lg-left my-auto">
        <ul class="list-inline mb-2">
          <li class="list-inline-item"><a href="/about.html">About</a></li>
          <li class="list-inline-item">&sdot;</li>
          <li class="list-inline-item"><a href="/contact.html">Contact</a></li>
          <li class="list-inline-item">&sdot;</li>
          <li class="list-inline-item"><a href="/terms.html">Terms of Use</a></li>
          <li class="list-inline-item">&sdot;</li>
          <li class="list-inline-item"><a href="/privacy.html">Privacy Policy</a></li>
        </ul>
        <p class="text-muted small mb-4 mb-lg-0">
          &copy; MongoDB 2022. All Rights Reserved.
        </p>
      </div>
    </div>
  </div>

  <!-- Bootstrap core JavaScript -->
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>

  <script>

    // Pagination. Number of results to retrieve and display.
    const pageSize = 10;

    // Convenience functions, get/set methods for the Page Number.
    function getPageNumber() {
      return parseInt(document.getElementById("hiddenPageNumber").value);

    }
    function setPageNumber(newPageNumber) {
      document.getElementById("hiddenPageNumber").value = newPageNumber;
    }

    // Clears the search results.
    function resetPage() {
      document.getElementById("queryResults").innerHTML = "";
      document.getElementById("paginationLinks").innerHTML = "";
    }

    // Fetch the next page of results.
    function getNext() {

      // Ensures that the query input field still matches the original query.
      document.getElementById("queryText").value = document.getElementById("hiddenQueryString").value;

      // Increment the page number and submit the query.
      newPageNumber = getPageNumber() + 1
      setPageNumber(newPageNumber);
      submitQuery(newPageNumber);

    }

    // Fetch the previous page of results.
    function getPrevious() {

      // Ensures that the query input field still matches the original query.
      document.getElementById("queryText").value = document.getElementById("hiddenQueryString").value;

      // Decrement the page number and submit the query.
      newPageNumber = getPageNumber() - 1
      setPageNumber(newPageNumber);
      submitQuery(newPageNumber);

    }

    // Submit form on pressing "enter"
    var input = document.getElementById("queryText");
    input.addEventListener("keypress", function(event) {
      if (event.key === "Enter") {
        event.preventDefault();
        document.getElementById("submitBtn").click();
      }
    });

    // Submit the query and process the results.
    // Page numbers starts at 0. 
    function submitQuery(pageNumber) {

      console.log("submitQuery: Start");

      setPageNumber(pageNumber);

      // Clear any existing search results.
      resetPage();

      // Construct the request object.
      var obj = {};
      obj.queryText = document.getElementById("queryText").value;
      obj.pageSize = pageSize;
      obj.pageNumber = getPageNumber();
      console.log("Query object is: " + JSON.stringify(obj));

      // Preserves the query string for future use in prev/next links.
      document.getElementById("hiddenQueryString").value = obj.queryText;

      fetch("/runQuery", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(obj)
      })
      // stopped using this method b/c it doesn't allow for processing of error status
      //.then(response => response.json())
      //.then(data => { }
      .then( function(response) {

        if (response.status == 200) {

          console.log("submitQuery: Response indicates success");
          response.json().then(searchResults => {

            let docCount = 0;
            let includeNextLink = false;
            for (const searchHit of searchResults) {

              console.log("searchHit: ", searchHit);
              docCount += 1;
              if (docCount <= pageSize) {

                let displayText = "";

                // Process search highlights.
                // See blog: https://www.mongodb.com/developer/products/atlas/visually-showing-atlas-search-highlights-javascript-html/
                searchHit.highlights.forEach(highlight => {
                  let texts = highlight.texts;
                  let replacements = texts.map(text => {
                      if(text.type == "hit") {
                          //return "<mark>" + text.value + "</mark>"; // leaves an unwanted trailing space.
                          return "<font class='hl'>" + text.value + "</font>";
                      } else {
                          return text.value;
                      }
                  }).join("");
                  if (displayText != "") { displayText += " ... "; }
                  displayText += replacements;
                });
                
                if ( displayText == "" && searchHit.hasOwnProperty('fullplot') ) { displayText = searchHit.fullplot };

                //displayResult(searchHit.title, searchHit.fullplot);
                displayResult(searchHit.title, displayText);
                console.log(searchHit.title, displayText);

              } else {
                // More records returned (i.e. 1 more) than configured page size,
                // So include a Next link.
                includeNextLink = true;
              }

            }

            pageLinksHTML = "";
            if (getPageNumber() > 0) {
              pageLinksHTML = "<a href='#' onclick='getPrevious()''>previous</a>"; 
            }

            if (includeNextLink) {
              if (pageLinksHTML != "") {
                pageLinksHTML += "&nbsp;&nbsp;&nbsp;";
              }
              pageLinksHTML += "<a href='#' onclick='getNext()''>next</a>"; 
            }
            document.getElementById("paginationLinks").innerHTML = pageLinksHTML;

          })

        } else {

          // Process error codes.
          // Server has to propagate a non-200 status as well as the error message content.
          document.getElementById("queryResults").innerHTML += "Oops. Something went wrong.";

          response.json().then(function(responseBody) {
            console.log("submitQuery: Response indicates FAIL", responseBody);
          });

        }

      })
      .catch((error) => {
        console.error('Error in submitQuery. ', error);
      })

    }

    // Displays a query result
    function displayResult(title, plotSummary) {
      document.getElementById("queryResults").innerHTML += 
        "<div class='card'><div class='card-body'>" + 
          "<h5 class='card-title'>" + title + "</h5>" +
          "<p class='card-text' style='font-size:14px'>" + plotSummary + "</p>" +
        "</div></div>"

    }


  </script>
</body>

</html>